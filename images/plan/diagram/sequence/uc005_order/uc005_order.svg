<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1257px" preserveAspectRatio="none" style="width:988px;height:1257px;background:#FFFFFF;" version="1.1" viewBox="0 0 988 1257" width="988px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="255" x="365.5" y="29.4023">UC005: 購入確定 シーケンス図</text><rect fill="#FFFFFF" height="1036.1797" style="stroke:#A80036;stroke-width:1.0;" width="10" x="24" y="129.6875"/><rect fill="#FFFFFF" height="71.6211" style="stroke:#A80036;stroke-width:1.0;" width="10" x="171" y="150.998"/><rect fill="#FFFFFF" height="793.3506" style="stroke:#A80036;stroke-width:1.0;" width="10" x="171" y="262.585"/><rect fill="#FFFFFF" height="71.6211" style="stroke:#A80036;stroke-width:1.0;" width="10" x="171" y="1085.2461"/><rect fill="#FFFFFF" height="639.4873" style="stroke:#A80036;stroke-width:1.0;" width="10" x="312" y="387.1377"/><rect fill="#FFFFFF" height="87.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="589.5" y="617.2773"/><rect fill="#FFFFFF" height="87.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="689.5" y="734.5195"/><rect fill="#FFFFFF" height="87.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="798" y="442.4141"/><rect fill="#FFFFFF" height="87.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="798" y="851.7617"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#A80036;stroke-width:1.0;" width="10" x="958" y="471.7246"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#A80036;stroke-width:1.0;" width="10" x="958" y="646.5879"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#A80036;stroke-width:1.0;" width="10" x="958" y="763.8301"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#A80036;stroke-width:1.0;" width="10" x="958" y="881.0723"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="29" x2="29" y1="119.6875" y2="1174.8672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="176" x2="176" y1="119.6875" y2="1174.8672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="317" x2="317" y1="119.6875" y2="1174.8672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="514" x2="514" y1="119.6875" y2="1174.8672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="594" x2="594" y1="119.6875" y2="1174.8672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="694" x2="694" y1="119.6875" y2="1174.8672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="803" x2="803" y1="119.6875" y2="1174.8672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="963" x2="963" y1="119.6875" y2="1174.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="5" y="116.7344">ユーザ</text><ellipse cx="29" cy="50.1992" fill="#FEFECE" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M29,58.1992 L29,85.1992 M16,66.1992 L42,66.1992 M29,85.1992 L16,100.1992 M29,85.1992 L42,100.1992 " fill="none" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="5" y="1187.4023">ユーザ</text><ellipse cx="29" cy="1200.3555" fill="#FEFECE" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M29,1208.3555 L29,1235.3555 M16,1216.3555 L42,1216.3555 M29,1235.3555 L16,1250.3555 M29,1235.3555 L42,1250.3555 " fill="none" style="stroke:#A80036;stroke-width:2.0;"/><rect fill="#FEFECE" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="84" x="134" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="156" y="92.2461">Order</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="70" x="141" y="108.7344">Controller</text><rect fill="#FEFECE" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="84" x="134" y="1173.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="156" y="1194.4023">Order</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="70" x="141" y="1210.8906">Controller</text><rect fill="#FEFECE" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="62" x="286" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="297" y="92.2461">Order</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="293" y="108.7344">Service</text><rect fill="#FEFECE" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="62" x="286" y="1173.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="297" y="1194.4023">Order</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48" x="293" y="1210.8906">Service</text><rect fill="#FEFECE" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="54" x="487" y="88.1992"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="494" y="108.7344">Order</text><rect fill="#FEFECE" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="54" x="487" y="1173.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="494" y="1194.4023">Order</text><rect fill="#FEFECE" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="87" x="551" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="574.5" y="92.2461">Order</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="558" y="108.7344">Repository</text><rect fill="#FEFECE" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="87" x="551" y="1173.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="574.5" y="1194.4023">Order</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="558" y="1210.8906">Repository</text><rect fill="#FEFECE" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="93" x="648" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="655" y="92.2461">OrderDetail</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="658" y="108.7344">Repository</text><rect fill="#FEFECE" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="93" x="648" y="1173.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="655" y="1194.4023">OrderDetail</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="658" y="1210.8906">Repository</text><rect fill="#FEFECE" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="104" x="751" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="90" x="758" y="92.2461">ProductStock</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="766.5" y="108.7344">Repository</text><rect fill="#FEFECE" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="104" x="751" y="1173.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="90" x="758" y="1194.4023">ProductStock</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="766.5" y="1210.8906">Repository</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18" x="951" y="116.7344">DB</text><path d="M945,67.1992 C945,57.1992 963,57.1992 963,57.1992 C963,57.1992 981,57.1992 981,67.1992 L981,93.1992 C981,103.1992 963,103.1992 963,103.1992 C963,103.1992 945,103.1992 945,93.1992 L945,67.1992 " fill="#FEFECE" style="stroke:#000000;stroke-width:1.5;"/><path d="M945,67.1992 C945,77.1992 963,77.1992 963,77.1992 C963,77.1992 981,77.1992 981,67.1992 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18" x="951" y="1187.4023">DB</text><path d="M945,1200.3555 C945,1190.3555 963,1190.3555 963,1190.3555 C963,1190.3555 981,1190.3555 981,1200.3555 L981,1226.3555 C981,1236.3555 963,1236.3555 963,1236.3555 C963,1236.3555 945,1236.3555 945,1226.3555 L945,1200.3555 " fill="#FEFECE" style="stroke:#000000;stroke-width:1.5;"/><path d="M945,1200.3555 C945,1210.3555 963,1210.3555 963,1210.3555 C963,1210.3555 981,1210.3555 981,1200.3555 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><rect fill="#FFFFFF" height="1036.1797" style="stroke:#A80036;stroke-width:1.0;" width="10" x="24" y="129.6875"/><rect fill="#FFFFFF" height="71.6211" style="stroke:#A80036;stroke-width:1.0;" width="10" x="171" y="150.998"/><rect fill="#FFFFFF" height="793.3506" style="stroke:#A80036;stroke-width:1.0;" width="10" x="171" y="262.585"/><rect fill="#FFFFFF" height="71.6211" style="stroke:#A80036;stroke-width:1.0;" width="10" x="171" y="1085.2461"/><rect fill="#FFFFFF" height="639.4873" style="stroke:#A80036;stroke-width:1.0;" width="10" x="312" y="387.1377"/><rect fill="#FFFFFF" height="87.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="589.5" y="617.2773"/><rect fill="#FFFFFF" height="87.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="689.5" y="734.5195"/><rect fill="#FFFFFF" height="87.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="798" y="442.4141"/><rect fill="#FFFFFF" height="87.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="798" y="851.7617"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#A80036;stroke-width:1.0;" width="10" x="958" y="471.7246"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#A80036;stroke-width:1.0;" width="10" x="958" y="646.5879"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#A80036;stroke-width:1.0;" width="10" x="958" y="763.8301"/><rect fill="#FFFFFF" height="29.3105" style="stroke:#A80036;stroke-width:1.0;" width="10" x="958" y="881.0723"/><polygon fill="#A80036" points="159,146.998,169,150.998,159,154.998,163,150.998" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="34" x2="165" y1="150.998" y2="150.998"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="41" y="146.2559">confirm(productId)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="181" x2="223" y1="180.3086" y2="180.3086"/><line style="stroke:#A80036;stroke-width:1.0;" x1="223" x2="223" y1="180.3086" y2="193.3086"/><line style="stroke:#A80036;stroke-width:1.0;" x1="182" x2="223" y1="193.3086" y2="193.3086"/><polygon fill="#A80036" points="192,189.3086,182,193.3086,192,197.3086,188,193.3086" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="188" y="175.5664">カートの中身を表示</text><polygon fill="#A80036" points="45,218.6191,35,222.6191,45,226.6191,41,222.6191" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="39" x2="175" y1="222.6191" y2="222.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="51" y="217.877">確認画面</text><polygon fill="#A80036" points="159,258.585,169,262.585,159,266.585,163,262.585" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="34" x2="165" y1="262.585" y2="262.585"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="57" x="41" y="257.8428">execute()</text><path d="M186,235.6191 L186,275.6191 L324,275.6191 L324,245.6191 L314,235.6191 L186,235.6191 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><path d="M314,235.6191 L314,245.6191 L324,245.6191 L314,235.6191 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="192" y="253.1875">未ログインだったら</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="192" y="268.498">ログイン画面を出す</text><polygon fill="#A80036" points="502,298.5508,512,302.5508,502,306.5508,506,302.5508" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="181" x2="508" y1="302.5508" y2="302.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228" x="188" y="297.8086">new(カート内容をエンティティに変換)</text><polygon fill="#A80036" points="192,327.8613,182,331.8613,192,335.8613,188,331.8613" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="186" x2="513" y1="331.8613" y2="331.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="35" x="198" y="327.1191">Order</text><polygon fill="#A80036" points="300,383.1377,310,387.1377,300,391.1377,304,387.1377" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="181" x2="306" y1="387.1377" y2="387.1377"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="188" y="382.3955">addOrder(Order)</text><path d="M327,344.8613 L327,415.8613 L491,415.8613 L491,354.8613 L481,344.8613 L327,344.8613 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><path d="M481,344.8613 L481,354.8613 L491,354.8613 L481,344.8613 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="333" y="362.4297">・在庫数を取得して</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="333" y="377.7402">　購入できるか確認</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="333" y="393.0508">　（悲観的ロック）</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="333" y="408.3613">・トランザクション処理</text><polygon fill="#A80036" points="786,438.4141,796,442.4141,786,446.4141,790,442.4141" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="322" x2="792" y1="442.4141" y2="442.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="194" x="329" y="437.6719">selectStockList(List&lt;Product&gt;)</text><polygon fill="#A80036" points="946,467.7246,956,471.7246,946,475.7246,950,471.7246" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="808" x2="952" y1="471.7246" y2="471.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77" x="815" y="466.9824">SQL(SELECT)</text><polygon fill="#A80036" points="819,497.0352,809,501.0352,819,505.0352,815,501.0352" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="813" x2="962" y1="501.0352" y2="501.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="825" y="496.293">List&lt;ProductStock&gt;</text><polygon fill="#A80036" points="333,526.3457,323,530.3457,333,534.3457,329,530.3457" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="327" x2="802" y1="530.3457" y2="530.3457"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="339" y="525.6035">List&lt;ProductStock&gt;</text><line style="stroke:#A80036;stroke-width:1.0;" x1="322" x2="364" y1="574.9668" y2="574.9668"/><line style="stroke:#A80036;stroke-width:1.0;" x1="364" x2="364" y1="574.9668" y2="587.9668"/><line style="stroke:#A80036;stroke-width:1.0;" x1="323" x2="364" y1="587.9668" y2="587.9668"/><polygon fill="#A80036" points="333,583.9668,323,587.9668,333,591.9668,329,587.9668" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="329" y="554.9141">checkStock</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="329" y="570.2246">(Order,List&lt;ProductStock&gt;)</text><path d="M514,546.8457 L514,586.8457 L674,586.8457 L674,556.8457 L664,546.8457 L514,546.8457 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><path d="M664,546.8457 L664,556.8457 L674,556.8457 L664,546.8457 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="520" y="564.4141">・Orderの数量と在庫を</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="520" y="579.7246">　比較してチェック</text><polygon fill="#A80036" points="577.5,613.2773,587.5,617.2773,577.5,621.2773,581.5,617.2773" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="322" x2="583.5" y1="617.2773" y2="617.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="329" y="612.5352">insert(Order)</text><polygon fill="#A80036" points="946,642.5879,956,646.5879,946,650.5879,950,646.5879" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="599.5" x2="952" y1="646.5879" y2="646.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="606.5" y="641.8457">SQL(INSERT)</text><polygon fill="#A80036" points="610.5,671.8984,600.5,675.8984,610.5,679.8984,606.5,675.8984" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="604.5" x2="962" y1="675.8984" y2="675.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="616.5" y="671.1563">viod</text><polygon fill="#A80036" points="333,701.209,323,705.209,333,709.209,329,705.209" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="327" x2="593.5" y1="705.209" y2="705.209"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="339" y="700.4668">viod</text><polygon fill="#A80036" points="677.5,730.5195,687.5,734.5195,677.5,738.5195,681.5,734.5195" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="322" x2="683.5" y1="734.5195" y2="734.5195"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="329" y="729.7773">insert(OrderDetail)</text><polygon fill="#A80036" points="946,759.8301,956,763.8301,946,767.8301,950,763.8301" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="699.5" x2="952" y1="763.8301" y2="763.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="706.5" y="759.0879">SQL(INSERT)</text><polygon fill="#A80036" points="710.5,789.1406,700.5,793.1406,710.5,797.1406,706.5,793.1406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="704.5" x2="962" y1="793.1406" y2="793.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="716.5" y="788.3984">viod</text><polygon fill="#A80036" points="333,818.4512,323,822.4512,333,826.4512,329,822.4512" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="327" x2="693.5" y1="822.4512" y2="822.4512"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="339" y="817.709">viod</text><polygon fill="#A80036" points="786,847.7617,796,851.7617,786,855.7617,790,851.7617" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="322" x2="792" y1="851.7617" y2="851.7617"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="329" y="847.0195">update(ProductStock)</text><polygon fill="#A80036" points="946,877.0723,956,881.0723,946,885.0723,950,881.0723" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="808" x2="952" y1="881.0723" y2="881.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="815" y="876.3301">SQL(UPDATE)</text><polygon fill="#A80036" points="819,906.3828,809,910.3828,819,914.3828,815,910.3828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="813" x2="962" y1="910.3828" y2="910.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="825" y="905.6406">viod</text><polygon fill="#A80036" points="333,935.6934,323,939.6934,333,943.6934,329,939.6934" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="327" x2="802" y1="939.6934" y2="939.6934"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="339" y="934.9512">viod</text><line style="stroke:#A80036;stroke-width:1.0;" x1="322" x2="364" y1="984.3145" y2="984.3145"/><line style="stroke:#A80036;stroke-width:1.0;" x1="364" x2="364" y1="984.3145" y2="997.3145"/><line style="stroke:#A80036;stroke-width:1.0;" x1="323" x2="364" y1="997.3145" y2="997.3145"/><polygon fill="#A80036" points="333,993.3145,323,997.3145,333,1001.3145,329,997.3145" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="329" y="964.2617">メール送信</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="329" y="979.5723">sendMail(Order)</text><path d="M440,956.1934 L440,996.1934 L682,996.1934 L682,966.1934 L672,956.1934 L440,956.1934 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><path d="M672,956.1934 L672,966.1934 L682,966.1934 L672,956.1934 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="446" y="973.7617">・顧客メールアドレス宛にメール送信</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="446" y="989.0723">・注文内容と振込先を送信</text><polygon fill="#A80036" points="192,1022.625,182,1026.625,192,1030.625,188,1026.625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="186" x2="316" y1="1026.625" y2="1026.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="198" y="1021.8828">viod</text><polygon fill="#A80036" points="45,1051.9355,35,1055.9355,45,1059.9355,41,1055.9355" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="39" x2="175" y1="1055.9355" y2="1055.9355"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="51" y="1051.1934">リダイレクト</text><polygon fill="#A80036" points="159,1081.2461,169,1085.2461,159,1089.2461,163,1085.2461" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="34" x2="165" y1="1085.2461" y2="1085.2461"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="41" y="1080.5039">complete()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="181" x2="223" y1="1114.5566" y2="1114.5566"/><line style="stroke:#A80036;stroke-width:1.0;" x1="223" x2="223" y1="1114.5566" y2="1127.5566"/><line style="stroke:#A80036;stroke-width:1.0;" x1="182" x2="223" y1="1127.5566" y2="1127.5566"/><polygon fill="#A80036" points="192,1123.5566,182,1127.5566,192,1131.5566,188,1127.5566" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="188" y="1109.8145">セッション解除</text><polygon fill="#A80036" points="45,1152.8672,35,1156.8672,45,1160.8672,41,1156.8672" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="39" x2="175" y1="1156.8672" y2="1156.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="51" y="1152.125">完了画面</text><!--MD5=[ab90d73d5c99a8e6b24402d5768acbdf]
@startuml
skin rose
skinparam shadowing false
hide empty methods
hide empty fields
skin rose
title UC005: 購入確定 シーケンス図
skinparam shadowing false
actor "ユーザ" as user
activate user
participant "Order\nController" as ctrl
participant "Order\nService" as svc
participant "Order" as od
participant "Order\nRepository" as repo1
participant "OrderDetail\nRepository" as repo2
' participant "OrderStatus\nRepository" as repo3
participant "ProductStock\nRepository" as repo4
database DB as db

' 確認画面
user -> ctrl ++ : confirm(productId)
ctrl -> ctrl : カートの中身を表示
ctrl -> user - - : 確認画面

' 完了画面
user -> ctrl ++ : execute()
note right
    未ログインだったら
    ログイン画面を出す
end note
ctrl -> od : new(カート内容をエンティティに変換)
ctrl <- - od : Order
ctrl -> svc ++ : addOrder(Order)
note right
    ・在庫数を取得して
    　購入できるか確認
    　（悲観的ロック）
    ・トランザクション処理
end note
svc -> repo4 ++ : selectStockList(List<Product>)
repo4 -> db ++ : SQL(SELECT)
repo4 <- - db - - : List<ProductStock>
svc <- - repo4 - - : List<ProductStock>
svc -> svc : checkStock\n(Order,List<ProductStock>)
note right
    ・Orderの数量と在庫を
    　比較してチェック
end note
svc -> repo1 ++ : insert(Order)
repo1 -> db ++ : SQL(INSERT)
repo1 <- - db - - : viod
svc <- - repo1 - - : viod
svc -> repo2 ++ : insert(OrderDetail)
repo2 -> db ++ : SQL(INSERT)
repo2 <- - db - - : viod
svc <- - repo2 - - : viod
svc -> repo4 ++ : update(ProductStock)
repo4 -> db ++ : SQL(UPDATE)
repo4 <- - db - - : viod
svc <- - repo4 - - : viod 
svc -> svc : メール送信\nsendMail(Order)
note right
    ・顧客メールアドレス宛にメール送信
    ・注文内容と振込先を送信
end note
ctrl <- - svc - - : viod
user <- - ctrl - - : リダイレクト
user -> ctrl ++ : complete()
ctrl -> ctrl : セッション解除
ctrl - -> user - - : 完了画面

@enduml

@startuml
skin rose
skinparam shadowing false
hide empty methods
hide empty fields
skin rose
title UC005: 購入確定 シーケンス図
skinparam shadowing false
actor "ユーザ" as user
activate user
participant "Order\nController" as ctrl
participant "Order\nService" as svc
participant "Order" as od
participant "Order\nRepository" as repo1
participant "OrderDetail\nRepository" as repo2
participant "ProductStock\nRepository" as repo4
database DB as db

user -> ctrl ++ : confirm(productId)
ctrl -> ctrl : カートの中身を表示
ctrl -> user - - : 確認画面

user -> ctrl ++ : execute()
note right
    未ログインだったら
    ログイン画面を出す
end note
ctrl -> od : new(カート内容をエンティティに変換)
ctrl <- - od : Order
ctrl -> svc ++ : addOrder(Order)
note right
    ・在庫数を取得して
    　購入できるか確認
    　（悲観的ロック）
    ・トランザクション処理
end note
svc -> repo4 ++ : selectStockList(List<Product>)
repo4 -> db ++ : SQL(SELECT)
repo4 <- - db - - : List<ProductStock>
svc <- - repo4 - - : List<ProductStock>
svc -> svc : checkStock\n(Order,List<ProductStock>)
note right
    ・Orderの数量と在庫を
    　比較してチェック
end note
svc -> repo1 ++ : insert(Order)
repo1 -> db ++ : SQL(INSERT)
repo1 <- - db - - : viod
svc <- - repo1 - - : viod
svc -> repo2 ++ : insert(OrderDetail)
repo2 -> db ++ : SQL(INSERT)
repo2 <- - db - - : viod
svc <- - repo2 - - : viod
svc -> repo4 ++ : update(ProductStock)
repo4 -> db ++ : SQL(UPDATE)
repo4 <- - db - - : viod
svc <- - repo4 - - : viod 
svc -> svc : メール送信\nsendMail(Order)
note right
    ・顧客メールアドレス宛にメール送信
    ・注文内容と振込先を送信
end note
ctrl <- - svc - - : viod
user <- - ctrl - - : リダイレクト
user -> ctrl ++ : complete()
ctrl -> ctrl : セッション解除
ctrl - -> user - - : 完了画面

@enduml

PlantUML version 1.2022.0(Wed Jan 12 01:16:42 JST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: ja
Country: JP
--></g></svg>